<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Luxura • Gestion d’inventaire</title>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <style>
    :root { --bg:#0b0b0b; --fg:#f7f7f7; --muted:#bdbdbd; --card:#111; --line:#1f1f1f; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:var(--fg)}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:36px;height:36px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center;color:#000;font-weight:800}
    .title{font-weight:700;letter-spacing:.3px;font-size:18px}
    .muted{color:var(--muted);font-size:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr 1fr}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0e0e0e;color:var(--fg)}
    input::placeholder{color:#7a7a7a}
    button{padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;color:#000;cursor:pointer;font-weight:600}
    .btn-ghost{background:transparent;color:var(--fg)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    h3{margin:0 0 10px;font-size:16px}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .ok{color:#8BE28B}.err{color:#ff8b8b}
    .kbd{font-family:ui-monospace,Menlo,monospace;background:#0e0e0e;border:1px solid var(--line);padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" id="logoSlot">L</div>
        <div>
          <div class="title">Luxura — Inventaire multi-salons</div>
          <div class="muted">UI HTMX prête pour Wix (noir & blanc).</div>
        </div>
      </div>
      <div class="muted">v0.1</div>
    </div>

    <!-- Config API + Logo -->
    <div class="card" style="margin-bottom:16px;">
      <div class="grid">
        <div>
          <label>URL de l'API</label>
          <input id="apiUrl" value="https://luxura-inventory-api.onrender.com" oninput="saveCfg()" />
          <div class="muted">Ex : <span class="kbd">https://luxura-inventory-api.onrender.com</span></div>
        </div>
        <div>
          <label>Clé API (x-api-key)</label>
          <input id="apiKey" placeholder="(si activée)" oninput="saveCfg()" />
          <div class="muted">Activer dans <span class="kbd">app/security.py</span></div>
        </div>
      </div>
      <div class="toolbar" style="margin-top:10px;">
        <button onclick="testApi()">Tester la connexion</button>
        <button class="btn-ghost" onclick="seed()">Charger des exemples</button>
        <span id="testStatus" class="muted"></span>
      </div>
      <div class="grid" style="margin-top:12px;">
        <div>
          <label>URL du logo Luxura (PNG/SVG)</label>
          <input id="logoUrl" placeholder="https://.../logo.png" oninput="saveLogo()">
          <div class="muted">L’icône “L” se mettra à jour.</div>
        </div>
        <div>
          <label>Presets produit</label>
          <div class="toolbar">
            <button onclick="preset('Genius i-Tips 18\\\"','GENIUS-ITIP-18-','18','Blond','149.00')">Genius i-Tips</button>
            <button onclick="preset('Bande adhésive 20\\\"','TAPE-20-','20','Châtain','129.00')">Bande adhésive</button>
            <button onclick="preset('Halo fil invisible 18\\\"','HALO-18-','18','Blond','169.00')">Halo</button>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Salons -->
      <div class="card">
        <h3>Salons</h3>
        <form class="toolbar" onsubmit="createSalon(event)">
          <input id="salonName" placeholder="Nom du salon">
          <input id="salonAddr" placeholder="Adresse (optionnel)">
          <button>Ajouter</button>
        </form>
        <div id="salonsList"></div>
      </div>

      <!-- Produits -->
      <div class="card">
        <h3>Produits</h3>
        <form class="toolbar" onsubmit="createProduct(event)">
          <input id="prodSku" placeholder="SKU">
          <input id="prodName" placeholder="Nom">
          <input id="prodLen" placeholder="Longueur (ex: 18)">
          <input id="prodColor" placeholder="Couleur (ex: Blond)">
          <input id="prodPrice" placeholder="Prix (ex: 149.00)">
          <button>Ajouter</button>
        </form>
        <div id="productsList"></div>
      </div>
    </div>

    <!-- Inventaire -->
    <div class="card" style="margin-top:16px;">
      <div class="toolbar">
        <h3 style="margin-right:auto;">Inventaire</h3>
        <select id="filterSalon"></select>
        <select id="filterProduct"></select>
        <button class="btn-ghost" onclick="loadInventory()">Actualiser</button>
      </div>
      <div id="inventoryTable"></div>
    </div>

    <div class="grid" style="margin-top:16px;">
      <!-- Mouvements -->
      <div class="card">
        <h3>Mouvement (IN / OUT / SALE / ADJUST)</h3>
        <div class="grid">
          <div>
            <label>Type</label>
            <select id="movType">
              <option>IN</option><option>OUT</option><option>SALE</option><option>ADJUST</option>
            </select>
          </div>
          <div><label>Salon</label><select id="movSalon"></select></div>
          <div><label>Produit</label><select id="movProduct"></select></div>
          <div><label>Quantité</label><input id="movQty" placeholder="+5 ou -5"></div>
          <div style="grid-column:1/-1;"><label>Note</label><input id="movNote" placeholder="(optionnel)"></div>
        </div>
        <div class="toolbar" style="margin-top:10px;">
          <button onclick="submitMovement()">Enregistrer</button>
          <span id="movStatus" class="muted"></span>
        </div>
      </div>

      <!-- Transferts -->
      <div class="card">
        <h3>Transfert entre salons</h3>
        <div class="grid">
          <div><label>De</label><select id="trFrom"></select></div>
          <div><label>Vers</label><select id="trTo"></select></div>
          <div><label>Produit</label><select id="trProduct"></select></div>
          <div><label>Quantité</label><input id="trQty" placeholder="ex: 3"></div>
        </div>
        <div class="toolbar" style="margin-top:10px;">
          <button onclick="submitTransfer()">Transférer</button>
          <span id="trStatus" class="muted"></span>
        </div>
      </div>
    </div>

    <div class="muted" style="margin-top:18px;">© Luxura Distribution — Outil interne (prototype)</div>
  </div>

<script>
  // --- Config persistance ---
  function cfg(){ return {
    apiUrl: localStorage.getItem('apiUrl') || document.getElementById('apiUrl').value,
    apiKey: localStorage.getItem('apiKey') || document.getElementById('apiKey').value
  } }
  function headers(){ const h={'Content-Type':'application/json'}; const k=cfg().apiKey; if(k) h['x-api-key']=k; return h; }
  function saveCfg(){ localStorage.setItem('apiUrl', document.getElementById('apiUrl').value); localStorage.setItem('apiKey', document.getElementById('apiKey').value); }
  function saveLogo(){
    const val = document.getElementById('logoUrl').value.trim();
    localStorage.setItem('logoUrl', val);
    const slot = document.getElementById('logoSlot');
    if(val){ slot.style.backgroundImage=`url(${val})`; slot.style.backgroundSize='cover'; slot.textContent=''; }
    else { slot.style.backgroundImage='none'; slot.textContent='L'; }
  }
  function setStatus(id,msg,ok=true){ const el=document.getElementById(id); el.textContent=msg; el.className= ok? 'ok muted':'err muted'; }

  async function testApi(){
    try{
      const r = await fetch(cfg().apiUrl + '/salons', { headers: headers() });
      if(r.ok) setStatus('testStatus','Connexion OK',true);
      else setStatus('testStatus','Erreur '+r.status,false);
    }catch(e){ setStatus('testStatus','Impossible de joindre l’API',false); }
    refreshAll();
  }
  async function seed(){
    // Si tu as gardé un endpoint /seed côté API, sinon créer manuellement un salon/produit
    alert("Astuce: crée 1 salon + 1 produit pour tester rapidement.");
  }

  // --- CRUD Salons/Produits ---
  async function createSalon(e){ e.preventDefault();
    const name=document.getElementById('salonName').value.trim(); if(!name) return;
    const address=document.getElementById('salonAddr').value.trim();
    const r=await fetch(cfg().apiUrl+'/salons',{method:'POST',headers:headers(),body:JSON.stringify({name,address})});
    if(r.ok){ document.getElementById('salonName').value=''; document.getElementById('salonAddr').value=''; loadSalons(); } else { alert('Erreur ajout salon'); }
  }

  async function createProduct(e){ e.preventDefault();
    const sku=val('prodSku'); const name=val('prodName'); if(!sku||!name) return;
    const length_inch = intOrNull('prodLen'); const color = val('prodColor')||null; const price = floatOrNull('prodPrice');
    const r=await fetch(cfg().apiUrl+'/products',{method:'POST',headers:headers(),body:JSON.stringify({sku,name,length_inch,color,price})});
    if(r.ok){ clear('prodSku','prodName','prodLen','prodColor','prodPrice'); loadProducts(); } else { alert('Erreur ajout produit'); }
  }

  function val(id){ return document.getElementById(id).value.trim(); }
  function clear(){ for(const id of arguments){ document.getElementById(id).value=''; } }
  function intOrNull(id){ const v=parseInt(val(id)||''); return Number.isFinite(v)?v:null; }
  function floatOrNull(id){ const v=parseFloat(val(id)||''); return Number.isFinite(v)?v:null; }

  async function loadSalons(){
    const r=await fetch(cfg().apiUrl+'/salons',{headers:headers()}); const rows=r.ok?await r.json():[];
    const opts = rows.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    for(const id of ['filterSalon','movSalon','trFrom','trTo']) document.getElementById(id).innerHTML = `<option value="">— Salon —</option>`+opts;
    document.getElementById('salonsList').innerHTML = `<table><tr><th>ID</th><th>Nom</th><th>Adresse</th></tr>${rows.map(s=>`<tr><td>${s.id}</td><td>${s.name}</td><td>${s.address||''}</td></tr>`).join('')}</table>`;
  }

  async function loadProducts(){
    const r=await fetch(cfg().apiUrl+'/products',{headers:headers()}); const rows=r.ok?await r.json():[];
    const opts = rows.map(p=>`<option value="${p.id}">${p.sku} — ${p.name}</option>`).join('');
    for(const id of ['filterProduct','movProduct','trProduct']) document.getElementById(id).innerHTML = `<option value="">— Produit —</option>`+opts;
    document.getElementById('productsList').innerHTML = `<table><tr><th>ID</th><th>SKU</th><th>Nom</th><th>Long.</th><th>Couleur</th><th>Prix</th></tr>${rows.map(p=>`<tr><td>${p.id}</td><td>${p.sku}</td><td>${p.name}</td><td>${p.length_inch||''}</td><td>${p.color||''}</td><td>${p.price ?? ''}</td></tr>`).join('')}</table>`;
  }

  async function loadInventory(){
    const salon = document.getElementById('filterSalon').value;
    const product = document.getElementById('filterProduct').value;
    const params = new URLSearchParams(); if(salon) params.append('salon_id',salon); if(product) params.append('product_id',product);
    const r=await fetch(cfg().apiUrl + '/inventory' + (params.toString()?`?${params.toString()}`:''), { headers: headers() });
    const rows=r.ok?await r.json():[];
    document.getElementById('inventoryTable').innerHTML = `<table><tr><th>Salon</th><th>Produit</th><th>SKU</th><th>Qté</th></tr>${rows.map(i=>`<tr><td>${i.salon_name||'-'}</td><td>${i.product_name||'-'}</td><td>${i.sku||'-'}</td><td>${i.quantity}</td></tr>`).join('')}</table>`;
  }

  async function submitMovement(){
    const type = document.getElementById('movType').value;
    const salon_id = parseInt(document.getElementById('movSalon').value);
    const product_id = parseInt(document.getElementById('movProduct').value);
    const qty = parseInt(document.getElementById('movQty').value);
    const note = document.getElementById('movNote').value || null;
    if(!salon_id||!product_id||!qty){ setStatus('movStatus','Champs manquants',false); return; }
    const r=await fetch(cfg().apiUrl+'/movement',{method:'POST',headers:headers(),body:JSON.stringify({type,salon_id,product_id,qty,note})});
    if(r.ok){ setStatus('movStatus','Mouvement enregistré',true); loadInventory(); } else { setStatus('movStatus','Erreur: '+(await r.text()),false); }
  }

  async function submitTransfer(){
    // Cette version de backend minimal n'a pas /transfers.
    // Si tu utilises la version avancée (avec /transfers), tu pourras la brancher ici.
    setStatus('trStatus','Transfert: ajoute l’endpoint /transfers côté API avancée',false);
  }

  (function init(){
    document.getElementById('apiUrl').value = localStorage.getItem('apiUrl') || document.getElementById('apiUrl').value;
    document.getElementById('apiKey').value = localStorage.getItem('apiKey') || '';
    const lu = localStorage.getItem('logoUrl'); if(lu){ document.getElementById('logoUrl').value = lu; saveLogo(); }
    refreshAll();
  })();

  async function refreshAll(){ await loadSalons(); await loadProducts(); await loadInventory(); }
</script>
</body>
</html>
